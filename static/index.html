<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SPEW: Shit PicturE Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              pixel: ["dos437-unicode", "mono"],
            },
            colors: {
              transparent: "transparent",
              current: "currentColor",
              white: "#fff",
              black: "#000",
              red: "#FF5555",
              "red-dark": "#AA0000",
              magenta: "#FF55FF",
              "magenta-dark": "#AA00AA",
              yellow: "#FFFF55",
              "yellow-dark": "#AAAA00",
              green: "#55FF55",
              "green-dark": "#00AA00",
              cyan: "#55FFFF",
              "cyan-dark": "#00AAAA",
              blue: "#5555FF",
              "blue-dark": "#0000AA",
              gray: "#AAaaAA",
              "gray-dark": "#555555",
              brown: "#AA5500",
            },
          },
        },
      };
    </script>
    <script src="wasm_exec.js"></script>
    <script>
      if (!WebAssembly.instantiateStreaming) {
        // polyfill
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
          const source = await (await resp).arrayBuffer();
          return await WebAssembly.instantiate(source, importObject);
        };
      }
      const go = new Go();
      WebAssembly.instantiateStreaming(
        fetch("main.wasm"),
        go.importObject,
      ).then((result) => {
        go.run(result.instance);
      });
    </script>
  </head>
  <body class="mx-auto p-8 max-w-screen-lg">
    <input type="file" />
    <img src="" class="max-w-[50vw] max-h-[50vh]" />
    <script>
      function downloadURI(uri, name) {
        var link = document.createElement("a");
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        delete link;
      }

      document.querySelector("input").addEventListener("change", async (e) => {
        let file = e.currentTarget.files[0];
        let buf = new Uint8Array(await file.arrayBuffer());
        console.log("starting");
        let start = new Date();
        let result = await uglify(buf);
        console.log("done", new Date() - start);
        document.querySelector("img").src = URL.createObjectURL(
          new Blob([result.buffer], { type: "image/jpeg" }),
        );
      });
      document.querySelector("img").addEventListener("click", (e) => {
        downloadURI(e.currentTarget.src, "shitpic.jpeg");
      });
    </script>
  </body>
</html>
